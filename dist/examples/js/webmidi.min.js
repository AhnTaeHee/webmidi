/*
 * webmidi - A browser library making it easier to develop with the Web MIDI API.
 *
 * Copyright (c) 2015, Jean-Philippe Côté <jp@cote.cc>
 *
 * For documentation, updates and examples, visit:
 *
 *    https://github.com/cotejp/webmidi
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this
 * software and associated documentation files (the "Software"), to deal in the Software
 * without restriction, including without limitation the rights to use, copy, modify,
 * merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies
 * or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
 * INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 * PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
 * THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
!function(a){"use strict";function b(){Object.defineProperties(this,{supported:{enumerable:!0,get:function(){return"requestMIDIAccess"in navigator}},connected:{enumerable:!0,get:function(){return void 0!==this["interface"]}},inputs:{enumerable:!0,get:function(){var a=[];if(this.connected)for(var b=this["interface"].inputs.values(),c=b.next();c&&!c.done;c=b.next())a.push(c.value);return a}},outputs:{enumerable:!0,get:function(){var a=[];if(this.connected)for(var b=this["interface"].outputs.values(),c=b.next();c&&!c.done;c=b.next())a.push(c.value);return a}},time:{enumerable:!0,get:function(){return window.performance.now()}}}),c()}function c(){h.system.statechange=[];for(var a in i)i.hasOwnProperty(a)&&(h.channel[a]=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]]);for(var b in j)j.hasOwnProperty(b)&&(h.system[b]=[])}function d(a){h.system.statechange.forEach(function(b){b(a)})}function e(a){var b,c,d=a.data[0]>>4,e=15&a.data[0];a.data.length>1&&(b=a.data[1],c=a.data.length>2?a.data[2]:void 0);var f={target:a.currentTarget,data:a.data,receivedTime:a.receivedTime,timeStamp:a.timeStamp,channel:e};d===i.noteoff||d===i.noteon&&0===c?(f.type="noteoff",f.note={number:b,name:k[b%12],octave:Math.floor(b/12-1)-3},f.velocity=c/127):d===i.noteon?(f.type="noteon",f.note={number:b,name:k[b%12],octave:Math.floor(b/12-1)-3},f.velocity=c/127):d===i.keyaftertouch?(f.type="keyaftertouch",f.note={number:b,name:k[b%12],octave:Math.floor(b/12-1)-3},f.value=c/127):d===i.controlchange&&b>=0&&119>=b?(f.type="controlchange",f.controller={number:b,name:""},f.value=c):d===i.channelmode&&b>=120&&127>=b?(f.type="channelmode",f.controller={number:b,name:""},f.value=c):d===i.programchange?(f.type="programchange",f.value=b):d===i.channelaftertouch?(f.type="channelaftertouch",f.value=b/127):d===i.pitchbend?(f.type="pitchbend",f.value=((c<<7)+b-8192)/8192):f.type="unknownchannelmessage",h.channel[f.type][e]&&h.channel[f.type][e].forEach(function(a){a(f)})}function f(a){var b=a.data[0],c={target:a.currentTarget,data:a.data,receivedTime:a.receivedTime,timeStamp:a.timeStamp};b===j.sysex?c.type="sysex":b===j.timecode?c.type="timecode":b===j.songposition?c.type="songposition":b===j.songselect?(c.type="songselect",c.song=a.data[1]):b===j.tuningrequest?c.type="tuningrequest":b===j.clock?c.type="clock":b===j.start?c.type="start":b===j["continue"]?c.type="continue":b===j.stop?c.type="stop":b===j.activesensing?c.type="activesensing":b===j.reset?c.type="reset":c.type="unknownsystemmessage",h.system[c.type]&&h.system[c.type].forEach(function(a){a(c)})}function g(a){a.data[0]<240?e(a):a.data[0]<=255&&f(a)}var h={channel:{},system:{}},i={noteoff:8,noteon:9,keyaftertouch:10,controlchange:11,channelmode:11,programchange:12,channelaftertouch:13,pitchbend:14},j={sysex:240,timecode:241,songposition:242,songselect:243,tuningrequest:246,clock:248,start:250,"continue":251,stop:252,activesensing:254,reset:255,unknownsystemmessage:-1},k=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];b.prototype.enable=function(a,b,c){var e=this;if(!this.supported&&b)return void b("The Web MIDI API is not supported by your browser.");var f={sysex:c};navigator.requestMIDIAccess(f).then(function(b){e["interface"]=b,e["interface"].onstatechange=d,e.inputs.forEach(function(a){a.onmidimessage=g}),a()},b)},b.prototype.addEventListener=function(a,b,c){if(!this.connected)throw new Error("WebMidi must be connected before adding event listeners.");if(void 0===c&&(c="all"),c.constructor!==Array&&(c=[c]),c.forEach(function(a){if("all"!==a&&!(a>=0&&15>=a))throw new RangeError("The channel must be an integer between 0 and 15 or the value 'all'.")}),"statechange"===a||j[a])h.system[a].push(b);else{if(!i[a])throw new TypeError("The specified event type is not supported.");if(c.indexOf("all")>-1){c=[];for(var d=0;16>d;d++)c.push(d)}c.forEach(function(c){h.channel[a][c]||(h.channel[a][c]=[]),h.channel[a][c].push(b)})}return this},b.prototype.hasEventListener=function(a,b,c){if(!this.connected)throw new Error("WebMidi must be connected before checking event listeners.");if(void 0===c&&(c="all"),"statechange"===a||j[a]){for(var d=0;d<h.system[a].length;d++)if(h.system[a][d]===b)return!0}else{if(i[a]&&"all"===c){for(var e=0;e<h.channel[a].length;e++){var f=h.channel[a][e];if(f.length<1)return!1;for(var g=0;g<f.length;g++)if(f[g]!==b)return!1}return!0}if(i[a])for(var k=0;k<h.channel[a][c].length;k++)if(h.channel[a][c][k]===b)return!0}return!1},b.prototype.removeEventListener=function(a,b,c){if(!this.connected)throw new Error("WebMidi must be connected before removing event listeners.");if(void 0===c&&(c="all"),"statechange"===a||j[a])for(var d=0;d<h.system[a].length;d++)h.system[a][d]===b&&h.system[a].splice(d,1);else if(i[a]&&"all"===c)for(var e=0;e<h.channel[a].length;e++)for(var f=h.channel[a][e],g=0;g<f.length;g++)f[g]===b&&f.splice(g,1);else if(i[a])for(var k=0;k<h.channel[a][c].length;k++)h.channel[a][c][k]===b&&h.channel[a][c].splice(k,1)},b.prototype.send=function(a,b,c,d){if(!this.connected)throw new Error("WebMidi must be connected before sending messages.");if("all"!==a&&(!this.outputs[a]||"connected"!==this.outputs[a].state))throw new ReferenceError("The requested channel ("+a+") is not available.");if(0>b||b>255)throw new RangeError("The command must be an integer between 0 and 255.");(void 0===c||c.constructor!==Array)&&(c=[]),void 0===d&&(d=0);var e=[];return c.forEach(function(a){void 0!==a&&e.push(a)}),"all"===a?(e.unshift(b),this.outputs.forEach(function(a){a.send(e,d)})):(e.unshift((b<<4)+a),this.outputs[a].send(e,d)),this},b.prototype.sendSystemMessage=function(a,b,c){if(!this.connected)throw new Error("WebMidi must be connected sending messages.");if(!j[a])throw new RangeError("The requested system command ("+a+") is not supported");return b&&b.constructor===Array||(b=[]),void 0===c&&(c=0),this.send("all",j[a],b,this.time+c),this},b.prototype.sendSysexMessage=function(a,b,c){if(!this.connected)throw new Error("WebMidi must be connected before sending messages.");return a.prototype!==Array&&(a=[a]),void 0===c&&(c=0),b=a.concat(b,j.sysexend),this.send("all",j.sysex,b,this.time+c),this},b.prototype.stopNote=function(a,b,c,d){var e=this,f=[];if(!this.connected)throw new Error("WebMidi must be connected before stopping notes.");if(void 0===b||null===b?b=[60]:Array.isArray(b)||(b=[b]),b.forEach(function(a){if(a.toFixed&&a>=0&&127>=a)f.push(a);else if(parseInt(a)>=0&&parseInt(a)<=127)f.push(parseInt(a));else{if(!("string"==typeof a||a instanceof String))throw new Error("Invalid note:"+a+".");f.push(e.noteNameToNumber(a))}}),0>c||c>1)throw new RangeError("The release velocity must be a decimal number between 0 and 1.");void 0===c&&(c=.5),void 0===d&&(d=0);var g=Math.round(127*c);return f.forEach(function(b){e.send(a,i.noteoff,[b,g],e.time+d)}),this},b.prototype.playNote=function(a,b,c,d,e){var f=this,g=[];if(!this.connected)throw new Error("WebMidi must be connected before playing notes.");if(void 0===b||null===b?b=[60]:Array.isArray(b)||(b=[b]),b.forEach(function(a){if(a.toFixed&&a>=0&&127>=a)g.push(a);else if(parseInt(a)>=0&&parseInt(a)<=127)g.push(parseInt(a));else{if(!("string"==typeof a||a instanceof String))throw new Error("Invalid note:"+a+".");g.push(f.noteNameToNumber(a))}}),0>c||c>1)throw new RangeError("The velocity must be a decimal number between 0 and 1.");void 0===c&&(c=.5),void 0===e&&(e=0);var h=Math.round(127*c),j=this.time+e;return g.forEach(function(b){f.send(a,i.noteon,[b,h],j)}),void 0!==d&&g.forEach(function(b){f.send(a,i.noteoff,[b,64],j+d)}),this},b.prototype.noteNameToNumber=function(a){var b=a.match(/([CDEFGABC]#?)(-?\d+)/i);if(!b)throw new RangeError("Invalid note name.");var c=k.indexOf(b[1].toUpperCase()),d=parseInt(b[2]),e=12*(d+2)+c;if(0>c||-2>d||d>8||0>e||e>127)throw new RangeError("Invalid note name or note outside valid range.");return e},b.prototype.sendKeyAftertouch=function(a,b,c,d){if(!this.connected)throw new Error("WebMidi must be connected before sending messages.");if(void 0===b||0>b||b>127)throw new RangeError("The note number must be between 0 and 127.");void 0===d&&(d=0);var e=Math.round(127*c);return this.send(a,i.keyaftertouch,[b,e],this.time+d),this},b.prototype.sendControlChange=function(a,b,c,d){if(!this.connected)throw new Error("WebMidi must be connected before sending messages.");if(void 0===b||0>b||b>119)throw new RangeError("Controller numbers must be between 0 and 119.");if(void 0===c||0>c||c>127)throw new RangeError("Value must be between 0 and 127.");return void 0===d&&(d=0),this.send(a,i.controlchange,[b,c],this.time+d),this},b.prototype.sendChannelMode=function(a,b,c,d){if(!this.connected)throw new Error("WebMidi must be connected before sending messages");if(void 0===b||120>b||b>127)throw new RangeError("Channel mode controller numbers must be between 120 and 127.");if(void 0===c||0>c||c>127)throw new RangeError("Value must be between 0 and 127.");return void 0===d&&(d=0),this.send(a,i.channelmode,[b,c],this.time+d),this},b.prototype.sendProgramChange=function(a,b,c){if(!this.connected)throw new Error("WebMidi must be connected before sending messages.");if(void 0===b||0>b||b>127)throw new RangeError("Program numbers must be between 0 and 127.");return void 0===c&&(c=0),this.send(a,i.programchange,[b],this.time+c),this},b.prototype.sendChannelAftertouch=function(a,b,c){if(!this.connected)throw new Error("WebMidi must be connected before sending messages.");void 0===c&&(c=0);var d=Math.round(127*b);return this.send(a,i.channelaftertouch,[d],this.time+c),this},b.prototype.sendPitchBend=function(a,b,c){if(!this.connected)throw new Error("WebMidi must be connected before sending messages.");if(void 0===c&&(c=0),-1>b||b>1)throw new RangeError("Pitch bend value must be between -1 and 1.");var d=Math.round((b+1)/2*16383),e=d>>7&127,f=127&d;return this.send(a,i.pitchbend,[f,e],this.time+c),this},"function"==typeof define&&"object"==typeof define.amd?define([],function(){return new b}):"undefined"!=typeof module&&module.exports?module.exports=b:a.WebMidi||(a.WebMidi=new b)}(this);